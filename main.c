#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <lua.h>

const char code_out[] = {
    0x1b, 0x4c, 0x75, 0x61, 0x53, 0x00, 0x19, 0x93, 0x0d, 0x0a, 0x1a, 0x0a,
    0x04, 0x08, 0x04, 0x08, 0x08, 0x78, 0x56, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x28, 0x77, 0x40, 0x01, 0x0a, 0x40,
    0x6d, 0x61, 0x69, 0x6e, 0x2e, 0x6c, 0x75, 0x61, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x03, 0x05, 0x00, 0x00, 0x00, 0x01,
    0x00, 0x00, 0x00, 0x41, 0x40, 0x00, 0x00, 0x8d, 0x40, 0x00, 0x00, 0xa6,
    0x00, 0x00, 0x01, 0x26, 0x00, 0x80, 0x00, 0x02, 0x00, 0x00, 0x00, 0x13,
    0x05, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x13, 0x0a, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x02,
    0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x04,
    0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x02, 0x61, 0x01, 0x00, 0x00,
    0x00, 0x05, 0x00, 0x00, 0x00, 0x02, 0x62, 0x02, 0x00, 0x00, 0x00, 0x05,
    0x00, 0x00, 0x00, 0x02, 0x63, 0x03, 0x00, 0x00, 0x00, 0x05, 0x00, 0x00,
    0x00, 0x01, 0x00, 0x00, 0x00, 0x05, 0x5f, 0x45, 0x4e, 0x56};
unsigned int code_out_len = 178;

static int panic(lua_State *L)
{
    printf("PANIC: unprotected error in call to Lua API (%s)\n",
           lua_tostring(L, -1));
    return 0; /* return to Lua to abort */
}

static void *l_alloc(void *ud, void *ptr, size_t osize, size_t nsize)
{
    (void)ud;
    if (nsize == 0)
    {
        //printf("FREE: %lu\n", osize);
        free(ptr);
        return NULL;
    }
    else
    {
        //printf("ALLOC: %lu %lu\n", osize, nsize);
        return realloc(ptr, nsize);
    }
}

static const char *load_buff(lua_State *L, void *ud, size_t *size)
{
    (void)L;
    int *left = (int *)ud;
    if (*left == 0)
        return NULL;
    *size = *left;
    *left = 0;
    return code_out;
}

int main(void)
{
    lua_State *L = lua_newstate(l_alloc, NULL);
    lua_atpanic(L, &panic);
    int left = code_out_len;
    lua_load(L, load_buff, &left, "buffer", NULL);
    lua_pcall(L, 0, LUA_MULTRET, 0);
    printf("result = %s\n", lua_tostring(L, -1));
    lua_close(L);
    return 0;
}
